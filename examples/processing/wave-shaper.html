<html>
	<head>
		<title>NEJS 2016 - Wave Shaper</title>
	</head>
	<body>

		<audio
			src="/assets/digitalsurgeons.mp3"
			controls
			data-audio-source>
		</audio>

		<p><strong>Distortion Intensity</strong></p>
		<input
			data-distortion-slider
			type="range"
			value="1000"
			min="1000"
			max="10000"
			step="1" />

		<script>
			// create web audio context
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

			// query DOM nodes
			const nodes = {
				audio: document.querySelector('[data-audio-source]'),
				distortionSlider: document.querySelector('[data-distortion-slider]'),
			};

			// create media element source node
			const audioSource = audioCtx.createMediaElementSource(nodes.audio);

			// create wave shaper node
			const waveShaper = audioCtx.createWaveShaper();
			waveShaper.curve = makeDistortionCurve();
			waveShaper.oversample = '4x';

			// connect video source to biquad filter
			// connect biquad filter to output
			audioSource.connect(waveShaper);
			waveShaper.connect(audioCtx.destination);

			// frequency slider change handler
			// nodes.frequencySlider.addEventListener('input', e => {
			// 	biquadFilter.frequency.value = e.currentTarget.value;
			// });

			function makeDistortionCurve(amount = 400) {
				const k = typeof amount === 'number' ? amount : 50;
				const n_samples = 44100;
				const curve = new Float32Array(n_samples);
				const deg = Math.PI / 180;

				let i = 0, x;

				for (; i < n_samples; ++i) {
					x = i * 2 / n_samples - 1;
					curve[i] = ( 3 + k ) * x * 20 * deg / (Math.PI + k * Math.abs(x));
				}

				return curve;
			};

			console.log(audioCtx);
			console.log(waveShaper);
		</script>
	</body>
</html>
