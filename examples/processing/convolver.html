<html>
	<head>
		<title>NEJS 2016 - Convolver</title>
	</head>
	<body>

		<audio
			src="/assets/nejs.ogg"
			controls
			loop
			data-audio-source>
		</audio>

		<p><strong>Reverb mix</strong></p>
		<input
			data-reverb-slider
			type="range"
			value="0"
			min="0"
			max="1"
			step=".05" />

		<script>
			// create web audio context
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

			// query DOM nodes
			const nodes = {
				audio: document.querySelector('[data-audio-source]'),
				reverbSlider: document.querySelector('[data-reverb-slider]'),
			};

			// create media element source node
			const audioSource = audioCtx.createMediaElementSource(nodes.audio);

			// create convolver node
			const convolver = audioCtx.createConvolver();

			// create gain node for convolver
			const convolverGain = audioCtx.createGain();
			convolverGain.gain.value = 0;

			let bufferSource, buffer;

			// fetch impulse mp3
			fetch('/assets/impulse.mp3')

			// fetch as array buffer
			.then(response => {
				return response.arrayBuffer();
			})
			.then(arrayBuffer => {
				// decode audio data from array buffer
				audioCtx.decodeAudioData(arrayBuffer, decodedAudio => {
					// set convolver buffer to decoded impulse
					convolver.buffer = decodedAudio;

					// connect audio element source directly to output
					audioSource.connect(audioCtx.destination);

					// connect audio element source to convolver gain
					// connect convolver gain to convolver
					// connect convolver to output
					audioSource.connect(convolverGain);
					convolverGain.connect(convolver);
					convolver.connect(audioCtx.destination);

					console.log(convolver);
				});
			});

			// reverb mix slider change handler
			nodes.reverbSlider.addEventListener('input', e => {
				convolverGain.gain.value = e.currentTarget.value;
			});

			console.log(audioCtx);
		</script>
	</body>
</html>
