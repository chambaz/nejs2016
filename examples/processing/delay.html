<html>
	<head>
		<title>NEJS 2016 - Delay</title>

		<style>
		body {
			display: flex;
			height: 100%;
			font-size: 30px;
			align-items: center;
			justify-content: center;
			flex-direction: column;
		}

		.buttons {
			display: flex;
			margin-top: 20px;
		}

		button {
			font-size: 20px;
			margin: 0 10px;
		}

		input[type="range"] {
			font-size: 30px;
		}
		</style>
	</head>
	<body>

		<p data-status>Decoding audio...</p>
		<input
			data-delay-slider
			type="range"
			value="0"
			min="0"
			max="1"
			step=".01" />

		<div class="buttons">
			<button data-play>Play</button>
			<button data-stop>Stop</button>
		</div>

		<script>
			// create web audio context
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

			// DOM nodes
			const ui = {
				'status': document.querySelector('[data-status]'),
				'play': document.querySelector('[data-play]'),
				'stop': document.querySelector('[data-stop]'),
				'slider': document.querySelector('[data-delay-slider]'),
			};

			// create delay node
			const delay = audioCtx.createDelay(5.0);

			// create gain node for delay
			const gainNode = audioCtx.createGain();
			gainNode.gain.value = .7;

			let bufferSource, buffer;

			// fetch mp3
			fetch('/assets/digitalsurgeons.mp3')

			// fetch as array buffer
			.then(response => {
				return response.arrayBuffer();
			})
			.then(arrayBuffer => {
				// decode audio data from array buffer
				audioCtx.decodeAudioData(arrayBuffer, decodedAudio => {
					console.log(decodedAudio);

					bufferSource = decodedAudio;
					ui.status.innerHTML = 'Audio decoded.';

					// create buffer, start and connect to delay
					// connect delay to output
					ui.play.addEventListener('click', e => {
						e.preventDefault();

						// buffer already started
						if (buffer) {
							false;
						}

						// create new buffer, connect to output and play
						buffer = audioCtx.createBufferSource();
						buffer.buffer = bufferSource;

						buffer.connect(audioCtx.destination);
						buffer.connect(delay);
						delay.connect(gainNode)
						gainNode.connect(audioCtx.destination);

						buffer.start(0);
					});

					// stop buffer
					ui.stop.addEventListener('click', e => {
						e.preventDefault();
						buffer.stop(0);
						buffer = false;
					});
				});
			});

			// update delay time with slider
			ui.slider.addEventListener('input', e => {
				delay.delayTime.value = e.currentTarget.value;
			});

			console.log(audioCtx);
			console.log(delay);
		</script>
	</body>
</html>
