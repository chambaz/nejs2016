<html>
	<head>
		<title>NEJS 2016 - Audio Buffer Decode Audio</title>
	</head>
	<body>

		<p data-status>Decoding audio...</p>
		<button data-play>Play</button>
		<button data-stop>Stop</button>

		<script>
			// create web audio context
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

			// DOM nodes
			const nodes = {
				'status': document.querySelector('[data-status]'),
				'play': document.querySelector('[data-play]'),
				'stop': document.querySelector('[data-stop]'),
			};

			let bufferSource, buffer;

			// fetch mp3
			fetch('/assets/digitalsurgeons.mp3')

			// fetch as array buffer
			.then(response => {
				return response.arrayBuffer();
			})
			.then(arrayBuffer => {
				// decode audio data from array buffer
				audioCtx.decodeAudioData(arrayBuffer, decodedAudio => {
					console.log(decodedAudio);

					buffer = decodedAudio;
					nodes.status.innerHTML = 'Audio decoded.';

					// play button click handler
					nodes.play.addEventListener('click', e => {
						e.preventDefault();

						// buffer already started
						if (bufferSource) {
							false;
						}

						// create new buffer, connect to output and play
						bufferSource = audioCtx.createBufferSource();
						bufferSource.buffer = buffer;
						bufferSource.connect(audioCtx.destination);
						bufferSource.start(0);
					});

					// stop button click handler
					nodes.stop.addEventListener('click', e => {
						e.preventDefault();
						bufferSource.stop(0);
						bufferSource = false;
					});
				});
			});

			console.log(audioCtx);
		</script>
	</body>
</html>
